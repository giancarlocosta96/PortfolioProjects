Select * 
From strictlybulk..sales
/* Columns: Date, Num_Invoices, Sales */

Select * 
From strictlybulk..Invoice
/*Columns: Date, Time, Purchase_ID, Invoice_ID, Product_Name, Quantity, Price, Discount, Total, Discount_Reason */

Select * 
From StrictlyBulk..product 
/* Columns: Product_ID, Product_Name, Type, Category, Current_Price, Category_ID */


--Data Cleaning: Check for missing values  

Select p.product_name as product, i.product_name as invoice
From StrictlyBulk..Invoice i
Full Join StrictlyBulk..product p
On i.product_name = p.product_name 
Where p.product_name is NULL
Or i.product_name is NULL 

--Ensuring products were classified correctly by type (i.e. Quantity for packaged products should not have decimal) 

Select i.purchase_id, i.Quantity
From StrictlyBulk..invoice i
Join StrictlyBulk..Product p
on i.Product_Name=p.Product_Name
Where p.type='Packaged'
and quantity LIKE '%.%'

--Market Basket Analysis 

Select Product_A, Product_B, count(*) AS Frequency
From (
    Select a.Product_Name as Product_A, b.Product_Name as Product_B
    From StrictlyBulk..Invoice a
    Join StrictlyBulk..Invoice b
    On a.Invoice_ID = b.Invoice_ID
    And a.Purchase_ID <> b.Purchase_ID
    Where a.Product_Name < b.Product_Name
) a
Group by Product_A, Product_B
Order by Frequency Desc

--Market Basket Analysis with Categories

WITH Invoice_3 AS
(Select i.*, p.Category, p.Category_ID
From StrictlyBulk..Invoice i
Join StrictlyBulk..Product p
On i.Product_Name=p.product_name
)
Select Category_A, Category_B, count(*) AS Frequency
From (
    Select a.Category as Category_A, b.Category as Category_B
    From Invoice_3 a
    Join Invoice_3 b
    On a.Invoice_ID = b.Invoice_ID
    And a.Purchase_ID <> b.Purchase_ID
    Where a.Category_ID < b.Category_ID
) a
Group by Category_A, Category_B
Order by Frequency Desc

-- Percent change in sales by month, quarter, and year, month sales rank, year to date sales by month

With Monthly_Sales AS (
Select year(date) as Year, month(date) AS Month, ROUND(Sum(sales),2) AS Month_sales, 
RANK() OVER(Order by Year(date) DESC, month(date) DESC) as Rank 
/* Rank is used to omit most recent month since month is not over and therefore incomplete */
From strictlybulk..sales
Group by year(date), month(date)
)
Select Year, Month, Month_sales,
ROUND((month_sales - LAG(month_sales) OVER(Order by Year, Month))/ 
LAG(month_sales) OVER(Order by Year, Month) * 100,2) AS Month_percent_change,
ROUND((month_sales - LAG(month_sales, 3) OVER(Order by Year, Month))/ 
LAG(month_sales, 3) OVER(Order by Year, Month) * 100,2) AS Quarter_percent_change,
ROUND((month_sales - LAG(month_sales, 12) OVER(Order by Year, Month))/ 
LAG(month_sales, 12) OVER(Order by Year, Month) * 100,2) AS Year_percent_change,
RANK() OVER(Partition by Year Order by Month_sales DESC) AS month_sales_rank,
SUM(Month_sales) OVER(Partition by Year Order by Year, Month) AS Year_to_date_sales
From Monthly_sales 
Where Rank>1
Order by Year Desc, Month Desc



--Percentage of sales for each category

With Category_sales AS
(
Select Category_ID, Category, Round(Sum(total),2) AS Total_sales
From StrictlyBulk..Invoice i
Join StrictlyBulk..Product p
On i.Product_name=p.Product_name 
Group by Category_ID, Category
)
Select *, ROUND((total_sales/Sum(total_sales) OVER())*100,2) AS Percentage_of_total 
From Category_sales 
Order by Percentage_of_total DESC 


--Top 5 Products Sold in Each Category

With Product_sales AS (
Select Category, Product_ID, p.Product_Name, Round(Sum(total),2) AS Total_sales,
ROW_NUMBER() OVER (Partition By Category Order by Round(Sum(total),2) DESC) as Row_number
From StrictlyBulk..Invoice i
Join StrictlyBulk..Product p
On i.Product_name=p.Product_name 
Group by Category, Product_ID, p.Product_Name
)
Select Category, Product_ID, Product_Name, Total_sales 
From Product_sales 
Where Row_number <= 5 
AND Category NOT IN('Bags and Containers', 'Deposits')
/* The categories 'Bags and Containers' and 'Deposits' are not relavent for this analysis */


--Average number of items per invoice 

WITH invoice_item_count AS (
Select date, Invoice_ID, CAST(count(invoice_ID) as float) as num_items
From strictlybulk..invoice
Group by Invoice_id, date 
)
Select avg(num_items) as avg_invoice_size
From invoice_item_count 
/*Filter for days*/
--Where day(date)>	
/*Filter for months*/
--Where month(date)>	



--Top 10 popular products

Select TOP 10 Product_Name, count(*) num_of_purchases 
From strictlybulk..Invoice
Group by Product_Name
Order by num_of_purchases Desc

--Top 10 bulk products purchased 

Select TOP 10 i.Product_Name, count(*) num_of_purchases 
From strictlybulk..Invoice i
Join StrictlyBulk..product p
On i.Product_Name=p.Product_Name
Where p.type='Bulk'
Group by i.Product_Name
Order by num_of_purchases Desc

--Top 10 bulk products purchased by quantity 

Select TOP 10 i.Product_Name, sum(quantity) as total_quantity
From strictlybulk..Invoice i
Join StrictlyBulk..product p
On i.Product_Name=p.Product_Name
Where p.type='Bulk'
Group by i.Product_Name
Order by total_quantity Desc


--Top 10 packaged products purchased 

Select TOP 10 i.Product_Name, count(*) num_of_purchases 
From strictlybulk..Invoice i
Join StrictlyBulk..product p
On i.Product_Name=p.Product_Name
Where p.type='Packaged'
Group by i.Product_Name
Order by num_of_purchases Desc

--Top 10 packaged products purchased by quantity 

Select TOP 10 i.Product_Name, sum(quantity) total_quantity
From strictlybulk..Invoice i
Join StrictlyBulk..product p
On i.Product_Name=p.Product_Name
Where p.type='Packaged'
Group by i.Product_Name
Order by total_quantity Desc


--Top 10 least popular products

Select TOP 10 Product_Name, count(*) num_of_purchases 
From strictlybulk..Invoice
Group by Product_Name
Order by num_of_purchases 

--Top 10 products generating highest revenue 

Select TOP 10 Product_Name, sum(total) revenue 
From strictlybulk..Invoice
Group by Product_Name
Order by revenue Desc 

--Revenue per Category 
 
Select p.category, sum(i.total) as total_revenue 
From StrictlyBulk..invoice i 
Join StrictlyBulk..product p 
On i.product_name=p.product_name 
Group by p.category 
Order by total_revenue Desc 


--Quantity of bulk vs packaging purchases 

Select p.type, count(*) as type_count
From strictlybulk..Product p
Join strictlyBulk..Invoice i
On p.product_name=i.product_name  
Group by type 


--Number of bulk purchases per category 

Select p.category, count(*) as num_purchases
From StrictlyBulk..Invoice i
Join StrictlyBulk..product p
On i.product_name=p.product_name 
Group by p.category, p.type 
Having p.type='Bulk'
Order by num_purchases Desc 

--Number of packaging purchases per category 

Select p.category, count(*) as num_purchases
From StrictlyBulk..Invoice i
Join StrictlyBulk..product p
On i.product_name=p.product_name 
Group by p.category, p.type 
Having p.type='Packaged'
Order by num_purchases Desc 

--Bulk vs Packaging with categories 

Select p.type, p.category, count(*) as num_purchases 
From StrictlyBulk..Invoice i
Join StrictlyBulk..Product p
On i.Product_Name=p.Product_Name
Group by p.type, p.category 
Order by num_purchases Desc 

--Sales trendy by day of week 

Select Datename(weekday,date) as day_of_week, avg(sales) as average_sales  
From StrictlyBulk..Sales 
Group by Datename(weekday,date)
Order by Datename(weekday,date)

--Discount Analysis 

--Top 10 items among seniors 

Select TOP 10 Product_name, count(*) as num_purchases
From StrictlyBulk..Invoice
Where Discount_Reason = 'Senior'
Group by product_name 
Order by num_purchases Desc 

--Revenue per type 

Select p.type, SUM(i.total) as Revenue 
From StrictlyBulk..invoice i
Join StrictlyBulk..Product p
on i.Product_Name=p.Product_Name
Group by p.type 






